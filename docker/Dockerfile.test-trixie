# syntax=docker/dockerfile:1.7
# Test image for pg_pinyin on PostgreSQL 18 (Debian trixie)
ARG BASE_IMAGE=postgres:18.3-trixie
FROM ${BASE_IMAGE}

ARG DEBIAN_FRONTEND=noninteractive
ARG PG_SEARCH_VERSION=0.21.10

ENV PATH=/root/.cargo/bin:$PATH \
    CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse

RUN set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    pkg-config \
    clang \
    llvm-dev \
    libc6-dev \
    make \
    pgtap \
    libpq5 \
    libpq-dev \
    postgresql-18 \
    postgresql-client-18 \
    postgresql-18-pgtap \
    postgresql-server-dev-18; \
  ARCH="$(dpkg --print-architecture)"; \
  case "$ARCH" in amd64|arm64) ;; *) echo "unsupported architecture for pg_search: $ARCH" >&2; exit 1 ;; esac; \
  PG_SEARCH_DEB="postgresql-18-pg-search_${PG_SEARCH_VERSION}-1PARADEDB-trixie_${ARCH}.deb"; \
  curl -fsSL -o "/tmp/${PG_SEARCH_DEB}" \
    "https://github.com/paradedb/paradedb/releases/download/v${PG_SEARCH_VERSION}/${PG_SEARCH_DEB}"; \
  apt-get install -y --no-install-recommends "/tmp/${PG_SEARCH_DEB}"; \
  update-ca-certificates; \
  rm -rf /var/lib/apt/lists/* /tmp/*

RUN --mount=type=cache,target=/root/.cargo/registry \
  --mount=type=cache,target=/root/.cargo/git \
  --mount=type=cache,target=/root/.rustup/downloads \
  set -eux; \
  curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal; \
  rustup default stable; \
  cargo install --locked cargo-pgrx --version 0.17.0

WORKDIR /work
COPY . /work
